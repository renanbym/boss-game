<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Sin Dragon</title>

    <style>
        body {
            background: #262626;
            overflow: hidden;
        }

        canvas {
            border: solid 0.5px rgb(33, 33, 33);
            display: block;
            margin: 0 auto;
        }
    </style>

    <script src="grid.js"></script>
    <script src="findPath.js"></script>
    <script src="Personagem.js"></script>
    <script src="Vilao.js"></script>
</head>

<body>

    <canvas width="1000" height="1000" id="container"></canvas>

    <script>
        const canvas = document.getElementById('container')
        const context = canvas.getContext('2d')

        const PIXEL = 40;

        const image = new Image()
        image.src = 'img/actor.png'

        const Gunslinger = new Personagem({
            x: 0,
            y: 1 * PIXEL,
            width: 49,
            height: 48,
            velocity: PIXEL,
            context,
            image,
        })

        const image1 = new Image()
        image1.src = 'img/Villager1.png'

        const Vilao = new Personagem({
            x: 2 * PIXEL,
            y: 15 * PIXEL,
            width: 49,
            height: 48,
            velocity: PIXEL,
            context,
            image: image1,
        })


        const loadImg = function loadImg(src) {
            'use strict';
            const paths = Array.isArray(src) ? src : [src];
            const promise = [];
            paths.forEach((path) => {
                promise.push(new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve({ path, img, status: 'ok' });
                    img.onerror = () => resolve({ path, img, status: 'error' });
                    img.src = path;
                }));
            });
            return Promise.all(promise);
        };

        const canvasBG = document.createElement('canvas')
        const contextBG = canvasBG.getContext('2d')
        canvasBG.width = canvas.width
        canvasBG.height = canvas.height

        const mapmap = [];

        loadImg([
            'img/bgs.png',
            'img/walls.png'
        ]).then(function (spritesheet) {
          
            for (let eixoY = 0; eixoY < MAP.length; eixoY++) {
                for (let eixoX = 0; eixoX < MAP[0].length; eixoX++) {

                    const [gridY, gridX, type] = [eixoY * PIXEL, eixoX * PIXEL, MAP[eixoY][eixoX]]

                    contextBG.drawImage(spritesheet[0].img, 4 * 48, 6 * 48, 48, 48, gridX, gridY, PIXEL, PIXEL)
                    
                    if (Math.random() > 0.85) contextBG.drawImage(spritesheet[0].img, 4 * 48, 13 * 48, 48, 48, gridX, gridY, PIXEL, PIXEL)

                    if (type == '1') {
                        contextBG.drawImage(spritesheet[1].img, 7 * 48, 12 * 48, 48, 48, gridX, gridY, PIXEL, PIXEL)
                    }

                }
            }
            render();

        });

        const render = () => {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(canvasBG, 0, 0)
            Gunslinger.render()
            Vilao.render()
        }

        Teclado.apply(Gunslinger);


        let next = true
        const nextStep = () => {
            this.SETA_ESQUERDA = 37;
            this.SETA_CIMA = 38;
            this.SETA_DIREITA = 39;
            this.SETA_BAIXO = 40;
            this.ESPACO = 32;

            const pathStart = [Vilao.x / PIXEL, Vilao.y / PIXEL]
            const pathEnd = [Gunslinger.x / PIXEL, Gunslinger.y / PIXEL]
      
            const currentPath = findPath(WORLD_INVERT, pathStart, pathEnd)

            if (currentPath[1]) {

                if (currentPath[1][1] != pathStart[1]) {
                    if (pathStart[1] > currentPath[1][1]) {
                        Vilao.lastPosition = this.SETA_CIMA;
                    }

                    if (currentPath[1][1] > pathStart[1]) {
                        Vilao.lastPosition = this.SETA_BAIXO;
                    }
                }

                if (currentPath[1][0] != pathStart[0]) {

                    if (pathStart[0] > currentPath[1][0]) {
                        Vilao.lastPosition = this.SETA_ESQUERDA;
                    }

                    if (currentPath[1][0] > pathStart[0]) {
                        Vilao.lastPosition = this.SETA_DIREITA;
                    }
                }

                Vilao.x = currentPath[1][0] * PIXEL
                Vilao.y = currentPath[1][1] * PIXEL

                Vilao.nextFrame()
                Vilao.render()
                render()
            } else {
                Gunslinger.live = false
                next = false
            }

            if (next) setTimeout(nextStep, 500)
        }
        setTimeout(nextStep, 500)


        function Teclado() {
            this.SETA_ESQUERDA = 37;
            this.SETA_CIMA = 38;
            this.SETA_DIREITA = 39;
            this.SETA_BAIXO = 40;
            this.ESPACO = 32;

            this.checkWall = (nextX, nextY) => {
                const find = WALLS.find(wall => wall[0] == nextX / PIXEL && wall[1] == nextY / PIXEL)
                if (find) return false
                return true
            }

            document.addEventListener('keydown', (event) => {

                if (event.keyCode == this.SETA_BAIXO) {

                    const next = this.y + this.velocity
                    if (this.checkWall(this.x, next)) {
                        this.lastPosition = this.SETA_BAIXO;
                        this.y = next > (canvas.height - this.height) ? (canvas.height - this.height) : next;

                        this.nextFrame();
                        this.render()
                        render();
                    }
                }

                if (event.keyCode == this.SETA_CIMA) {

                    const next = this.y - this.velocity
                    if (this.checkWall(this.x, next)) {
                        this.lastPosition = this.SETA_CIMA;
                        this.y = next <= 0 ? 0 : next;

                        this.nextFrame();
                        this.render()
                        render();
                    }
                }

                if (event.keyCode == this.SETA_DIREITA) {
                    const next = this.x + this.velocity
                    if (this.checkWall(next, this.y)) {
                        this.lastPosition = this.SETA_DIREITA;
                        this.x = next > (canvas.height - this.width) ? (canvas.width - this.width) : next;

                        this.nextFrame();
                        this.render()
                        render();
                    }
                }

                if (event.keyCode == this.SETA_ESQUERDA) {
                    const next = this.x - this.velocity
                    if (this.checkWall(next, this.y)) {
                        this.lastPosition = this.SETA_ESQUERDA;
                        this.x = next <= 0 ? 0 : next;

                        this.nextFrame();
                        this.render()
                        render();
                    }
                }

                if (event.keyCode == this.ESPACO) {

                }
            })
        }


    </script>

</body>

</html>